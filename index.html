<!doctype html>
<html lang="hy">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Telegram Mini App — Online Bisnes</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{padding:18px;background:#f5f7fb;color:#111}
    .card{background:white;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    .row{display:flex;gap:8px;align-items:center}
    select,input,button{padding:10px;border-radius:8px;border:1px solid #e3e6ef}
    button{background:#2a8bf2;color:white;border:none;cursor:pointer}
    .small{font-size:13px;color:#556}
    .product{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
    .product:last-child{border-bottom:none}
    .cart-item{display:flex;justify-content:space-between;padding:6px 0}
    .muted{color:#667;}
    .danger{color:#b33}
    textarea{width:100%;min-height:64px}
  </style>
</head>
<body>
  <h2>Mini Store — Telegram Web App</h2>
  <div class="card">
    <div class="small">Ընտրեք տարածքը</div>
    <select id="district">
      <option>Կենտրոն</option>
      <option>Կոմիտաս</option>
      <option>Աջափնյակ</option>
      <option>Մասիվ</option>
      <option>Նոր Նորք</option>
    </select>
  </div>

  <div class="card">
    <div class="small">Ապրանքներ</div>
    <div id="products"></div>
  </div>

  <div class="card">
    <div class="small">Պատվերի էջ</div>
    <div id="cart"></div>
    <div style="margin-top:8px" class="row">
      <button id="checkoutBtn">Վճարել / Send to bot</button>
      <div class="muted" style="margin-left:auto" id="totalUSD">Ընդհանուր՝ $0.00</div>
    </div>
  </div>

  <div class="card" id="paymentCard" style="display:none">
    <div class="small">Վճարում (DASH)</div>
    <div class="row"><div class="muted">Փոխանցել այս հասցեին:</div><div style="margin-left:auto" id="dashAddr">—</div></div>
    <div class="small" style="margin-top:8px">Փոխանցում արեք և տեղադրեք գործարքի (tx) ID</div>
    <input id="txid" placeholder="Մուտքագրեք TXID (օրինակ՝ c980d2...)" style="width:100%">
    <div style="margin-top:8px" class="row">
      <button id="verifyTx">Ստուգել TX</button>
      <div id="txStatus" class="muted" style="margin-left:8px"></div>
    </div>
    <div style="margin-top:10px" class="small muted">Նշում. եթե API-ն բարդ պատճառներով չի արձագանքում, ստուգող արձագանքը կարող է անհամապատասխան լինել։</div>
  </div>

  <script>
    // CONFIG — Ստուգեք ու թարմացրեք ըստ ձեր պահանջի
    const DASH_ADDRESS = 'XxYourDashAddressHereX'; // <-- փոխել ձեր DASH հասցեով

    // Ապրանքի արժեքներ USD-ում
    const PRODUCTS = [
      { id: '0.5g', title: 'Էնտրի 0.5G (1 հատ)', weight:'0.5G', priceUsd:26 },
      { id: '1.0g', title: 'Էնտրի 1.0G (1 հատ)', weight:'1.0G', priceUsd:35 }
    ];

    // Քննարկում — մենք չենք կատարում USD->DASH փոխարկում ավտոմատ՝ առանց API
    // Այդ պատճառով այստեղ դուք կարող եք սահմանել նվազագույնի պահանջը անմիջապես DASH-ով
    const REQUIRED_DASH = {
      '0.5g': 0.01, // 0.01 DASH որպես օրինակ; փոխել ըստ իսկական պահանջի
      '1.0g': 0.02  // 0.02 DASH որպես օրինակ
    };

    // ==================================
    // UI bootstrap
    const productsEl = document.getElementById('products');
    const cartEl = document.getElementById('cart');
    const totalUSDel = document.getElementById('totalUSD');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const paymentCard = document.getElementById('paymentCard');
    const dashAddrEl = document.getElementById('dashAddr');
    const txidInput = document.getElementById('txid');
    const verifyBtn = document.getElementById('verifyTx');
    const txStatus = document.getElementById('txStatus');

    let cart = {};

    function renderProducts(){
      productsEl.innerHTML='';
      PRODUCTS.forEach(p=>{
        const div = document.createElement('div'); div.className='product';
        div.innerHTML = `
          <div>
            <div><strong>${p.title}</strong></div>
            <div class="small muted">${p.weight} — $${p.priceUsd}</div>
          </div>
          <div style="min-width:170px;text-align:right">
            <input type="number" min="0" step="1" value="0" data-id="${p.id}" style="width:72px"> <button data-add="${p.id}">Ավելացնել</button>
          </div>`;
        productsEl.appendChild(div);
      });

      // add handlers
      productsEl.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = e.target.getAttribute('data-add');
          const qtyInput = productsEl.querySelector(`input[data-id="${id}"]`);
          const q = parseInt(qtyInput.value||'0',10);
          if(q>0){ cart[id] = (cart[id]||0) + q; qtyInput.value = 0; renderCart(); }
        });
      });
    }

    function renderCart(){
      cartEl.innerHTML='';
      let total = 0;
      for(const id in cart){
        const p = PRODUCTS.find(x=>x.id===id);
        const qty = cart[id];
        const row = document.createElement('div'); row.className='cart-item';
        row.innerHTML = `<div>${p.title} × ${qty}</div><div>$${(p.priceUsd*qty).toFixed(2)} <button data-rem="${id}">x</button></div>`;
        cartEl.appendChild(row);
        total += p.priceUsd*qty;
      }
      if(Object.keys(cart).length===0) cartEl.innerHTML='<div class="muted">Գման չապրանք</div>';
      totalUSDel.textContent = 'Ընդհանուր՝ $' + total.toFixed(2);
      cartEl.querySelectorAll('[data-rem]').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.getAttribute('data-rem'); delete cart[id]; renderCart(); }));
    }

    checkoutBtn.addEventListener('click', ()=>{
      if(Object.keys(cart).length===0){ alert('Սկզբի համար ավելացրե՛ք առնվազն 1 ապրանք։'); return; }

      // Ստեղծել պատվերի մեթա
      const district = document.getElementById('district').value;
      const orderItems = Object.keys(cart).map(id=>{
        const p = PRODUCTS.find(x=>x.id===id);
        return { id, title:p.title, qty:cart[id], priceUsd:p.priceUsd };
      });
      const totalUsd = orderItems.reduce((s,i)=>s + i.qty*i.priceUsd, 0);

      // Սահմանել որեւէ պահանջ DASH-ում (մի քանի ապրանք առանց փոխարկման => նայում ենք ամենամեծ պահանջը)
      let requiredDash = 0;
      for(const id in cart){ requiredDash = Math.max(requiredDash, REQUIRED_DASH[id] || 0); }

      // Ցույց տալ ուղեցույցը վճարման համար
      paymentCard.style.display = 'block';
      dashAddrEl.textContent = DASH_ADDRESS;

      // Պատրաստել ներքին խնդիրը, որը ուղարկվում է դեպի bot՝ sendData-ով
      const payload = { type:'order_preview', district, items:orderItems, totalUsd, requiredDash };

      // If running inside Telegram WebApp, show MainButton and prepare send
      if(window.Telegram && window.Telegram.WebApp){
        try{
          window.Telegram.WebApp.MainButton.setText('Գործարք ուղարկել բոտին');
          window.Telegram.WebApp.MainButton.show();
          window.Telegram.WebApp.MainButton.onClick(()=>{
            // Send order preview JSON to bot via sendData
            window.Telegram.WebApp.sendData(JSON.stringify(payload));
          });
        }catch(e){ console.warn(e); }
      } else {
        // not in Telegram — fallback: copy JSON to clipboard
        alert('Բառացիորեն բոտ-մոդ կամ Telegram WebView-ում չէք: Պատվերի տվյալները պատճենվել են clipboard-ին. Խնդրում ենք ուղարկել դրանք ձեր բոտին.');
        navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
      }
    });

    // TX verification — basic implementation using Insight API
    verifyBtn.addEventListener('click', async ()=>{
      const txid = (txidInput.value||'').trim();
      txStatus.textContent = '';
      if(!txid){ txStatus.textContent = 'Տվեք TXID'; return; }

      txStatus.textContent = 'Ստուգվում...';

      try{
        // Example API: https://explorer.dash.org/insight-api/tx/{txid}
        const res = await fetch('https://explorer.dash.org/insight-api/tx/' + txid);
        if(!res.ok){ txStatus.textContent = 'API error: ' + res.status; return; }
        const data = await res.json();

        // Քանի որ API ֆորմատը կարող է տարբեր լինել, փորձենք գտնել ելքային արժեքները ու հասցեները
        let totalToOurAddr = 0;
        if(Array.isArray(data.vout)){
          for(const v of data.vout){
            if(v.scriptPubKey && v.scriptPubKey.addresses){
              if(v.scriptPubKey.addresses.includes(DASH_ADDRESS)){
                // v.value usually փողի արժեքն է (Dash)
                totalToOurAddr += parseFloat(v.value||0);
              }
            }
          }
        }

        // Վերցնել պահանջը (եթե պատվերը դեռ պահպանված չէ՝ վերցնել վերջին պատվերից)
        // Здесь простой подход: берем максимальный REQUIRED_DASH среди cart
        let required = 0;
        for(const id in cart) required = Math.max(required, REQUIRED_DASH[id] || 0);

        if(totalToOurAddr >= required && totalToOurAddr>0){
          txStatus.innerHTML = 'OK — TX հաստատված, փոխանցվել է ' + totalToOurAddr + ' DASH. Ստուգեք բոտը՝ պրոցեսը ավարտելու համար.';

          // Отправляем сам TXID в бота (если Telegram WebApp доступен)
          if(window.Telegram && window.Telegram.WebApp){
            const sendPayload = { type:'tx_confirm', txid, paidDash: totalToOurAddr };
            window.Telegram.WebApp.sendData(JSON.stringify(sendPayload));
          }

        } else {
          txStatus.innerHTML = 'Փոխանցումը չի բավարարում պահանջը: Մենք ստացանք ' + totalToOurAddr + ' DASH — պահանջվել է նվազագույնը ' + required + ' DASH.';
        }

      }catch(err){ console.error(err); txStatus.textContent = 'Սխալ ստուգման ընթացքում: ' + err.message; }
    });

    // սկիզբ
    renderProducts(); renderCart();

  </script>
</body>
</html>
